@model WebApplication2.Models.User

@{
    ViewData["Title"] = "Billing Dashboard";
    var user = Model;
}

<style>
    /* Reuse dark theme from Account page */
    .dashboard-wrap {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: 220px 1fr;
        gap: 1.25rem;
        align-items: start;
    }

    /* Left vertical nav */
    .dash-nav {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        position: sticky;
        top: 90px;
        align-self: start;
    }

        .dash-nav .nav-box {
            background: linear-gradient(145deg, #0a1a2f, #071226);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid #122b4a;
            text-align: center;
            font-weight: 700;
            color: #9aa4ae;
            cursor: pointer;
            transition: all 0.18s ease;
        }

            .dash-nav .nav-box:hover {
                transform: translateY(-3px);
                color: #e9eef2;
                box-shadow: 0 8px 25px rgba(30,144,255,0.06);
            }

            .dash-nav .nav-box.active {
                color: #1e90ff;
                background: linear-gradient(135deg, rgba(30,144,255,0.06), rgba(30,144,255,0.02));
                border: 1px solid #1e90ff;
                box-shadow: 0 10px 30px rgba(30,144,255,0.06);
            }

    /* Main card */
    .dash-card {
        background: linear-gradient(145deg, #0a1a2f, #050505);
        border-radius: 16px;
        padding: 1.5rem;
        border: 1px solid #1c2a3d;
        box-shadow: 0 8px 25px rgba(30,144,255,0.06);
    }

    .dash-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .dash-title {
        color: #1e90ff;
        font-weight: 700;
        font-size: 1.5rem;
    }

    .form-section {
        background: linear-gradient(145deg,#071226,#050b14);
        border-radius: 12px;
        padding: 1rem;
        border: 1px solid #122b4a;
    }

        .form-section .form-label {
            color: #9aa4ae;
            font-weight: 600;
        }

    .form-control.custom {
        background: #071226;
        border: 1px solid #122b4a;
        color: #e9eef2;
        border-radius: 8px;
        padding: 0.6rem 0.8rem;
        width: 100%;
    }

    .btn-primary-accent {
        background: linear-gradient(135deg,#1e90ff,#0073e6);
        color: white;
        border: none;
        padding: 0.6rem 1rem;
        border-radius: 8px;
        font-weight: 700;
    }

    .user-info {
        display: grid;
        grid-template-columns: 1fr;
    }

    .btn-danger-accent {
        background: linear-gradient(135deg,#dc3545,#b21f2d) !important;
        color: white !important;
        border: none !important;
        padding: 0.6rem 1rem;
        border-radius: 8px;
        font-weight: 700;
        transition: all 0.2s ease;
    }

        .btn-danger-accent:hover,
        .btn-danger-accent:focus {
            background: linear-gradient(135deg,#b21f2d,#a01828) !important;
            color: white !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(220,53,69,0.3);
        }


</style>

<div class="dashboard-wrap">
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="dashboard-grid">
        <!-- Left nav -->
        <div class="dash-nav" style="flex-direction: column; padding-top:2rem;">
            <a href="@Url.Action("Index", "Dashboard")" class="text-decoration-none">
                <div class="nav-box" title="Account">
                    Account
                </div>
            </a>

            <div class="nav-box active" title="Billing">
                Billing
            </div>
        </div>

        <!-- Main content -->
        <div>
            <div class="dash-card">
                <div class="dash-header">
                    <div class="dash-title">Billing</div>
                </div>

                <!-- Existing form-section for adding new bank details -->
                <!-- Current Bank Details -->
                @if (user.Banks != null && user.Banks.Any())
                {
                    <div class="form-section mt-2 mb-4">
                        <h5 style="color:#1e90ff">Your Bank Accounts</h5>
                        <p class="muted">Manage your saved bank accounts. You can remove a bank if needed.</p>

                        <div class="user-info">
                            @foreach (var bank in Model.Banks ?? Enumerable.Empty<WebApplication2.Models.Bank>())
                            {
                                <div class="info-box d-flex justify-content-between align-items-center mb-3"
                                     style="transition: transform 0.2s; cursor:pointer;"
                                     onmouseover="this.style.transform='translateY(-3px)';"
                                     onmouseout="this.style.transform='translateY(0)';">
                                    <div>
                                        <div class="info-label">Bank Name:</div>
                                        <div class="info-value">@bank.BankName</div>

                                        <div class="muted">Account Title: @bank.AccountTitle</div>
                                        <div class="muted">Account Number: @bank.AccountNumber</div>
                                        <div class="muted">Account Type: @bank.AccountType</div>
                                    </div>

                                    <div class="text-end">
                                        <button type="button" class="btn btn-danger-accent btn-sm"
                                                data-bs-toggle="modal" data-bs-target="#deleteModal"
                                                data-bankid="@bank.BankId" data-bankname="@bank.BankName">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }



                <div class="form-section">
                    <h5 style="color:#1e90ff">Bank & Wallet Details</h5>

                    <form asp-action="SaveBilling" method="post">
                        @Html.AntiForgeryToken()

                        <div class="mb-2">
                            <label class="form-label" for="bankName">Bank Name</label>
                            <select name="BankName" id="bankName" class="form-control custom" required>
                                <option value="">Select your bank</option>
                                <option value="HBL">Habib Bank Limited (HBL)</option>
                                <option value="UBL">United Bank Limited (UBL)</option>
                                <option value="MCB">Muslim Commercial Bank (MCB)</option>
                                <option value="ABL">Allied Bank Limited (ABL)</option>
                                <option value="NBP">National Bank of Pakistan (NBP)</option>
                                <option value="Meezan">Meezan Bank</option>
                                <option value="Standard">Standard Chartered</option>
                                <option value="Faysal">Faysal Bank</option>
                                <option value="Bank Al Habib">Bank Al Habib</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="mb-2">
                            <label class="form-label" for="accountTitle">Account Title</label>
                            <input type="text" name="AccountTitle" id="accountTitle" class="form-control custom" placeholder="Enter account holder name" required />
                        </div>

                        <div class="mb-2">
                            <label class="form-label" for="accountNumber">Account Number</label>
                            <input type="text" name="AccountNumber" id="accountNumber" class="form-control custom" placeholder="Enter account number or IBAN" required />
                        </div>


                        <div class="mb-2">
                            <label class="form-label" for="accountType">Account Type</label>
                            <select name="AccountType" id="accountType" class="form-control custom" required>
                                <option value="">Select account type</option>
                                <option value="Savings">Savings Account</option>
                                <option value="Current">Current Account</option>
                                <option value="Islamic">Islamic Account</option>
                            </select>
                        </div>


                        <div class="d-flex justify-content-end mt-3">
                            <button type="submit" class="btn btn-primary-accent">Save Details</button>
                        </div>
                    </form>
                </div>
            </div> <!-- dash card -->
        </div>
    </div> <!-- dashboard grid -->
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete <strong id="modalBankName"></strong> from your bank records? This action cannot be undone.
                <div class="mt-3">
                    <label for="confirmPasswordModal" class="form-label">Confirm with your password:</label>
                    <input type="password" id="confirmPasswordModal" class="form-control custom" placeholder="Enter your password" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteBankForm" method="post" asp-action="DeleteBank">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="bankId" id="modalBankId" />
                    <input type="hidden" name="confirmPassword" id="modalConfirmPassword" />
                    <button type="submit" class="btn btn-danger-accent">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>


<script>
    var deleteModal = document.getElementById('deleteModal');
    deleteModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var bankId = button.getAttribute('data-bankid');
        var bankName = button.getAttribute('data-bankname');

        // Update modal content
        document.getElementById('modalBankName').textContent = bankName;
        document.getElementById('modalBankId').value = bankId;

        // Clear previous password input
        document.getElementById('confirmPasswordModal').value = '';
    });

    // Copy password into hidden input on form submit
    document.getElementById('deleteBankForm').addEventListener('submit', function (e) {
        var pw = document.getElementById('confirmPasswordModal').value;
        if (!pw) {
            e.preventDefault();
            alert('Please enter your password to confirm.');
            return false;
        }
        document.getElementById('modalConfirmPassword').value = pw;
    });
</script>
